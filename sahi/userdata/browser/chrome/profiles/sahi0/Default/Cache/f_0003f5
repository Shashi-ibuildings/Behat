Locale.use(document.getElement("html").get("lang"));

var sVendorPrefix;
switch(Browser.name) {
    case "firefox":
    case "mozilla":
        sVendorPrefix = "-moz-";
    break;
    case "safari":
    case "chrome":
        sVendorPrefix = "-webkit-";
    break;
    case "opera":
        sVendorPrefix = "-o-";
    break;
    case "ie":
        sVendorPrefix = "-ms-";
    break;
    default:
        sVendorPrefix = "";
    break;
}

var fnOverlay = function() {
        var oOverlay = new Element("div", {
            "id": "overlay",
            "events": {
                "click": function(e) {
                    e.preventDefault();
                    fnDisposeObj(oOverlay);
                }
            }
        }).inject(document.body, "top");

        document.addEvent("keydown", function(e) {
            if (e.key == "esc") {
                fnDisposeObj(oOverlay);
            }
        });
        return oOverlay;
    },
    doAjax = function(reqURL, callback, callbackArgs) {
        document.getElement("body").addClass("loading");
        new Request.HTML({
            url: reqURL,
            data: "",
            link: "cancel",
            method: "get",
            evalScripts: false,
            headers: {
                "X-header": "AJAX",
                "Accept": "text/javascript, text/html, application/xml, text/xml, */*"
            },
            onComplete: function() {
                document.getElement("body").removeClass("loading");
            },
            onSuccess: function(respTree, respElements, respHTML, respJS) {
                if (callback) {
                    callback({
                        "tree": respTree,
                        "elements": respElements,
                        "html": respHTML,
                        "js": respJS
                    }, callbackArgs);
                }
            }
        }).send();
    },
    getCookie = function(c_name) {
        var i,x,y,ARRcookies=document.cookie.split(";");
        for (i=0;i<ARRcookies.length;i++)
        {
            x=ARRcookies[i].substr(0,ARRcookies[i].indexOf("="));
            y=ARRcookies[i].substr(ARRcookies[i].indexOf("=")+1);
            x=x.replace(/^\s+|\s+$/g,"");

            if (x==c_name)
            {
                return unescape(y);
            }
        }
    },
    setCookie = function(c_name,value,exdays) {
        var exdate=new Date();
        exdate.setDate(exdate.getDate() + exdays);
        var c_value=escape(value) + ((exdays==null) ? "" : "; expires="+exdate.toUTCString());
        document.cookie=c_name + "=" + c_value;
    },
    fnFadeinObjs = function(aObj, iDuration) {
        var obj = aObj.shift();
        if (obj) {
            obj.setStyle("visibility", "visible");
            new Fx.Tween(obj, {
                duration: iDuration,
                transition: sTransition,
                onComplete: function() {
                    fnFadeinObjs(aObj, iDuration);
                }
            }).start("opacity", 0, 1);
        }
    },
    fnFadeoutObjs = function(aObj, iDuration) {
        var obj = aObj.shift();
        if (obj) {
            new Fx.Tween(obj, {
                duration: iDuration,
                transition: sTransition,
                onComplete: function() {
                    fnFadeoutObjs(aObj, iDuration);
                }
            }).start("opacity", 0);
        }
    },
    fnDisposeObj = function(mObj) {
        var oObj = document.id(mObj);
        if (oObj) {
            new Fx.Tween(oObj, {
                duration: 500,
                onComplete: function() {
                    this.dispose();
                }.bind(oObj)
            }).start("opacity", 0);
        }
    },
    fnPopulateFooterNav = function(idx, bHash, oTarget) {
        var iCurrIdx = 1, oTarget = oTarget||document.getElement("footer nav ul");
        if (bHash) {
            var sHash = document.location.hash,
                regFindInt = /\d+$/g;
            iCurrIdx = (sHash && !isNaN(sHash.match(regFindInt)))?sHash.match(regFindInt)[0]:1;
        }
        new Element("li").adopt(
            new Element("a", {
                "html": (idx+1 < 10)?"0"+(idx+1):idx+1,
                "href": "javascript:;",
                "rel": "navigate",
                "class": (idx == iCurrIdx-1)?"active":""
            })
        ).inject(oTarget);
    },
    fnResizeScrollArea = function() {
        var oLeftScroll = document.getElement("a[rel=scroll].left"),
            oRightScroll = document.getElement("a[rel=scroll].right");
        if (oLeftScroll && oRightScroll) {
            var iScrollWidth = parseInt((window.getSize().x.toInt() - document.getElement("body article").getSize().x.toInt())/2, 10);
            oLeftScroll.setStyles({
                "left": -iScrollWidth,
                "width": iScrollWidth
            });
            oRightScroll.setStyles({
                "right": -iScrollWidth,
                "width": iScrollWidth
            });
        }
    },
    fnSetupColourSize = function() {
        if (window.spConfig) {
            var oColourSelect = document.id("select-colour"),
                oSizeSelect = document.id("select-size"),
                ssColourSelect = null,
                ssSizeSelect = null,
                fnUpdateStock = function(oData, obj) {
                    var oDiv = obj.getNext("div.styleme"),
                        oLI = oDiv.getElement("li.clicked"),
                        oSpan = oDiv.getElement("span");

                    oSpan.set("html", oLI.get("html") + " " + oData.html);
                    oLI.set("html", oLI.get("html") + " " + oData.html);
                };

            if (oColourSelect) {
                oColourSelect.adopt(
                    new Element("option", {
                        value: "",
                        text: Locale.get("String.forms.colour")
                    })
                );

                var iColourID = "509",
                    oColours = Object.getFromPath(spConfig.attributes, iColourID)||{};

                oColours.options.each(function(obj) {
                    oColourSelect.adopt(
                        new Element("option", {
                            "value": obj.id,
                            "text": obj.label
                        })
                    );
                });

                if (oColourSelect) {
                    oColourSelect.addEvent("change", function(e) {
                        if (oSizeSelect) {
                            // empty the size select, apart from first item
                            oSizeSelect.getElements("option:not(:first-child)").dispose();

                            // create a lookup of product information
                            oProductInfoLookup = {};
                            oSizes.options.each(function(obj) {
                                obj.products.each(function(iProductId) {
                                    oProductInfoLookup[iProductId] = {"id": obj.id, "size": obj.label};
                                });
                            });

                            // populate product information for selected colour
                            // we only have a list of in stock product id's associated with a colour, so we
                            // need the lookup data from above to populate the size select list
                            iSelectedColour = this.options[this.selectedIndex].value;
                            oColours.options.each(function(obj) {

                                if (obj.id == iSelectedColour) {
                                    aSelectedProducts = obj.products;

                                    aSelectedProducts.each(function(iProductId) {
                                        oSizeSelect.adopt(
                                            new Element("option", {
                                                "value": oProductInfoLookup[iProductId].id,
                                                "text": oProductInfoLookup[iProductId].size
                                            })
                                        );
                                    });

                                }

                            });
                            ssSizeSelect.rebuild();
                        } else {
                            var oData = new Object();
                            oData[iColourID] = ssColourSelect.getSelected().value;

                            var sURL = "/checkout/cart/available/?product=" + spConfig.productId + "&" + Object.toQueryString(oData, "super_attribute");
                            doAjax(sURL, fnUpdateStock, oColourSelect);
                        }
                    });
                }

                ssColourSelect = new StyleSelect({
                    element: oColourSelect,
                    skipfirst: true
                });
            }

            if (oSizeSelect) {
                oSizeSelect.adopt(
                    new Element("option", {
                        value: "",
                        text: Locale.get("String.forms.size")
                    })
                );

                var iSizeID = "508",
                    oSizes = Object.getFromPath(spConfig.attributes, iSizeID)||{};

                if (!oColourSelect) {
                    oSizeSelect.getElements("option:not(:first-child)").dispose();
                    oSizes.options.each(function(obj) {
                        oSizeSelect.adopt(
                            new Element("option", {
                                "value": obj.id,
                                "text": obj.label
                            })
                        )
                    });

                    oSizeSelect.addEvent("change", function(e) {
                        var oData = new Object();
                        oData[iSizeID] = ssSizeSelect.getSelected().value;

                        var sURL = "/checkout/cart/available/?product=" + spConfig.productId + "&" + Object.toQueryString(oData, "super_attribute");
                        doAjax(sURL, fnUpdateStock, oSizeSelect);
                    });
                } else {
                    oSizeSelect.adopt(
                        new Element("option", {
                            value: "",
                            text: Locale.get("String.forms.selectcolourabove")
                        })
                    );
                    oSizeSelect.addEvent("change", function(e) {
                        var oData = new Object();
                        oData[iSizeID] = ssSizeSelect.getSelected().value;
                        oData[iColourID] = ssColourSelect.getSelected().value;

                        var sURL = "/checkout/cart/available/?product=" + spConfig.productId + "&" + Object.toQueryString(oData, "super_attribute");
                        doAjax(sURL, fnUpdateStock, oSizeSelect);
                    });
                }

                ssSizeSelect = new StyleSelect({
                    element: oSizeSelect,
                    skipfirst: true
                });
            }
        }
    },
    fnShare = function(e) {
        e.preventDefault();
        var oA = e.target,
            sURL = "",
            d = document,
            fnE = encodeURIComponent,
            sClass = oA.get("class");

        switch(sClass) {
            case "facebook":
                sURL = "http://www.facebook.com/sharer/sharer.php?u=" + fnE(d.location.href) + "&t=" + fnE(d.title);
            break;
            case "twitter":
                sURL = "http://twitter.com/share?url=" + fnE(d.location.href) + "&text=" + fnE(d.title) + "&via=acneonline&related=acneonline";
            break;
        }

        window.open(sURL,'sharer','toolbar=0,status=0,resizable=1,width=626,height=436');
    },
    fnSlidePeriod = null,
    iPaneInterval = 4000,
    sTransition = "quart:in:out",
    bCSSTransitions = document.getElement("html").hasClass("csstransitions"),
    bLegacyBrowser = Browser.ie && Browser.version <= 8,
    aPreloadImages = new Array(),
    aPreloadBGImgs = new Array();

var fadeDescription = function(index, callback) {
    var callbackAndFadeIn = function() {
        callback();
        setTimeout( function() {
            jQuery('ul.articles').eq(index-1).find('div.description').fadeIn(300);
        }, 1500); // CSS transition takes 1.5s
    };

    visible = jQuery('div.description').filter(':visible');
    if (visible.length) {
        visible.fadeOut(300, function() { callbackAndFadeIn() });
    } else {
        callbackAndFadeIn();
    }
};

window.addEvents({
    "domready": function(e) {
        fnResizeScrollArea();

        if (Browser.Platform.ios) {
            /*
             * iOS Product list item click event handler
             * Displays product information on first click, loads product page on second click.
             */
    		jQuery('body.catalog-category-view figure a, body.catalogsearch-result-index figure a').click(function(event) {
    			if (!jQuery(this).parents('figure').hasClass('active')) {
    				jQuery('figure.active').removeClass('active');
    				jQuery(this).parents('figure').addClass('active');

    				event.preventDefault();
    				return false;
    			}
    		});

            $$("img").addEvent("error", function() {
                var oParent = this.getParent("figure"),
                        sPath = this.get("src");

                this.dispose();
                delete this;
                oParent.setStyle("background-image", "url(" + sPath +")");
            });

        }

        aPreloadImages = $$("img").map(function(obj) {
            return obj.get("src");
        }).slice(1, $$("img").length);

        aPreloadBGImgs = $$("*[style*=background-image]").map(function(obj) {
            return obj.getStyle("background-image").match(/[^\("]+\.(gif|jpg|jpeg|png)/g)[0];
        });

        Asset.images(aPreloadImages.append(aPreloadBGImgs), {
            onProgress: function(count) {
                var iPercent = parseInt((count / aPreloadImages.length) * 100, 10),
                    oPreload = document.id("preload");

                oPreload.setStyle("width", iPercent + "%");
                oPreload.setAttribute("value", iPercent);
            }
        });

        if (!Modernizr.input.required) {
            $$("form .required").each(function(oInput) {
                oInput.getParent("form").addClass("js-required");
            })
        }

        // Set platform identifier in body class
        document.getElement("html").addClass(Browser.Platform.name);

        var oHeader = document.getElement("header"),
            oFooter = document.getElement("footer"),
            oStartpage = document.getElement("body.cms-index-index"),
            oShoppage = document.getElement("body.category-men")||document.getElement("body.category-women"),
            oItempage = document.getElement("body.catalog-product-view"),
            oCategorypage = document.getElement("body.catalog-category-view"),
            oSearchpage = document.getElement("body.catalogsearch-result-index"),
            oCollectionpage = document.getElement("body.collection-slideshow"),
            oCareerpage = document.getElement("body.cms-job-vacancies"),
            oCmsSlideshow = document.getElement("body.cms-slideshow"),
            oANavigation = document.id("nav-link"),
            oANavClose = document.id("nav-close"),
            oShoppingbag = oHeader.getElement("nav.shoppingbag"),
            oAShoppingbag = document.id("nav-shoppingbag"),
            fnSiteSearch = function(e) {
            },
            fnToggleShoppingbag = function(e) {
                if (e) {
                    e.stopPropagation();
                    e.preventDefault();
                }
                if (oHeader.hasClass("shoppingbag")) {
                    oHeader.removeClass("shoppingbag");
                } else {
                    oHeader.addClass("shoppingbag");
                }
            };

        /*
        * Remove extra CSS-classes from BODY-tag if Magento CMS is adding additional classes on the item page.
        * */
        if (oItempage && oShoppage) {
            oShoppage = undefined;
            oItempage.removeClass("category-men");
            oItempage.removeClass("category-women");
        }

        /*
        * Set some customized HTML/CSS for legacy browsers
        * */
        if (bLegacyBrowser) {

            jQuery("article.slides section ul").each(function(index) {
            	jQuery(this).css('left',(index * 200) + "%");
            	jQuery(this).css('position','absolute');
            });
        }

        $$("a[rel*=external]").addEvent("click", function(e) {
            e.preventDefault();
            window.open(this.href);
        });

        /*
        * Add CSS-class to force fade in/out between pages
        * Firefox only as the other browsers lags heavily
        * */
        if (Browser.firefox) {
            $$("a:not([rel]):not([href*=javascript]):not([id])").addEvent("click", function(e) {
                e.stopPropagation();
                e.preventDefault();
                if (bCSSTransitions) {
                    document.getElement("body").addClass("unload");
                } else {
                    var aObjs = [document.id("logo")].append([document.getElement("article")]);
                    fnFadeoutObjs(aObjs, 400);
                }
                (function() {
                    document.location.href = this.href;
                }).delay(800, this);
            })
        }

        if (oShoppingbag && oAShoppingbag) {
            oShoppingbag.getElements("td.remove > a").addEvent("click", function(e) {
                e.preventDefault();
                var bConfirm = confirm(Locale.get("String.userinput.deletecart"));
                if (bConfirm) {
                    document.location.href = this.href;
                }
            })
        }

        $$("a[rel=share]").addEvent("click", fnShare);

        /*
        * Misc javascript for iPad/iPhone browsers
        * */
        if (Browser.Platform.ios || Browser.Platform.android || Browser.Platform.webos || Browser.Platform.other) {
            $$("div.widget ul.looks li").set('html', '<img src="/images/mobile_banner.jpg" alt="" />');
        }

        if (Browser.Platform.ios) {
            if (window.navigator.standalone) {
                document.body.addClass("standalone");
            }

            new Element("aside#orientation").adopt(
                    new Element("h1", {html: Locale.get("String.optimizemobile.title")}),
                    new Element("p", {html: Locale.get("String.optimizemobile.text")}),
                    new Element("a", {
                        html: Locale.get("String.optimizemobile.ok"),
                        "events": {
                            "click": function(e) {
                                fnDisposeObj(this.getParent("aside"))
                            }
                        }
                    })
            ).inject(document.getElement("article"));

            $$("video:not([controls])").addEvent("ended", function() {
                this.currentTime = 0.1;
                this.play();
            }).setProperty("controls", "controls");
        }

        if (Browser.ie7 && !Cookie.read('ie7-warning-shown')) {
        	if (document.getElement("body")) {
	            new Element("aside#optimizeie7").adopt(
	                    new Element("h1", {html: Locale.get("String.optimizeie7.title")}),
	                    new Element("p", {html: Locale.get("String.optimizeie7.text")}),
	                    new Element("a", {
	                        html: Locale.get("String.optimizeie7.ok"),
	                        "events": {
	                            "click": function(e) {
	                                fnDisposeObj(this.getParent("aside"))
	                            }
	                        }
	                    })
	            ).inject(document.getElement("body"));

	            Cookie.write('ie7-warning-shown',true);
        	}
        }

        /*
        * Add events to videos that has no controls enabled
        * */
        $$("video:not([controls])").addEvent("click", function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (this.paused || this.ended) {
                oHeader.removeClass("navigation");
                this.play();
            } else {
                oHeader.addClass("navigation");
                this.pause();
            }
        });

        /*
        * Add events for when user presses various keys
        * */
        document.addEvents({
            "keydown": function(e) {
                if (e.key == "f3") {
                    e.preventDefault();
                }
            },
            "click": function(e) {
                oHeader.removeClass("navigation");
                oHeader.removeClass("shopping");
            }
        });
        
        if (jQuery('footer form#newsletter-validate-detail').length > 0) {
            if (getCookie('newsletter_subcription_form_shown') != 'true') {
                jQuery('form#newsletter-validate-detail').show();
	    		jQuery('#popup-overlay').show();
                setCookie('newsletter_subcription_form_shown', true, 360);
            }
        
            jQuery('a.newsletter-subscription').click(function(event) {
                jQuery('form#newsletter-validate-detail').show();
	    		jQuery('#popup-overlay').show();
	    		
	    		return false;
            });
        }

        jQuery('form#newsletter-validate-detail').submit(function(event) {
            event.preventDefault();
            var postData = jQuery(this).serialize();
            data = null;
            jQuery.post(jQuery(this).attr('action'), postData, function(data) {
                errorMessages = jQuery(data).find('li.error-msg');
                successMessages = jQuery(data).find('li.success-msg');
                if (errorMessages.length > 0) {
                    jQuery('ul#newsletter-validate-errors').empty();
                    jQuery('ul#newsletter-validate-errors').prepend(errorMessages);
                }
                else if (successMessages.length > 0) {
                    jQuery('ul#newsletter-validate-errors').empty();
                    jQuery('ul#newsletter-validate-errors').prepend(successMessages);
                    setTimeout("jQuery('footer form#newsletter-validate-detail').hide();jQuery('#popup-overlay').hide();",5000);
                }
            });
        });

		jQuery('form#newsletter-validate-detail .close').click(function(){
			jQuery('form#newsletter-validate-detail').hide();
			jQuery('#popup-overlay').hide();
		});

        // page specifics
        if (oStartpage) {
            var aUL = $$("ul.looks"),
                iCurrIdx = 0,
                oLogo = document.id("logo"),
                iPaneDuration = 1700,
                aValidKeystrokes = ["left", "right"],
                fxPane = null,
                fnPane = function(iIdx, sDir) {
                    if (iIdx < 0) {
                        iIdx = aUL.length-1;
                    } else if (iIdx > aUL.length-1) {
                        iIdx = 0;
                    }
                    iCurrIdx = iIdx.limit(0, aUL.length-1);

                    var oUL = aUL[iCurrIdx],
                        iStartPos = (sDir == "right")?220:-220,
                        iEndPos = (sDir != "right")?220:-220;

                    if (fxPane == null) {
                        fxPane = new Fx.Tween(oUL, {
                            unit: "%",
                            transition: sTransition,
                            link: "chain",
                            duration: iPaneDuration,
                            onStart: function() {
                                var aLeft = aUL.map(function(obj) {
                                    return obj.getStyle("left").toInt().round();
                                }),
                                oNextUL = aUL[aLeft.closestzero()];
                                new Fx.Tween(oNextUL, {
                                    unit: "%",
                                    transition: sTransition,
                                    duration: iPaneDuration,
                                    onComplete: function() {
                                        oNextUL.removeClass("active");
                                    }
                                }).start("left", 50, iEndPos);
                            },
                            onComplete: function() {
                                fxPane = null;
                                oUL.addClass("active");
                                oLogo.getParent("a").set("href", oUL.getElement("li:first-child a").get("href"));
                            }
                        }).start("left", iStartPos, 50);
                    }
                };

            if (aUL.length > 1) {
                fnSlidePeriod = (function() {
                    fnPane(++iCurrIdx, "right");
                }).periodical(iPaneInterval);
            }

            document.addEvent("keydown", function(e) {
                if (aValidKeystrokes.contains(e.key)) {
                    e.preventDefault();
                    if (e.key == "left") {
                        fnPane(--iCurrIdx, e.key);
                    } else {
                        fnPane(++iCurrIdx, e.key);
                    }
                    clearInterval(fnSlidePeriod);
                    fnSlidePeriod = (function() {
                        fnPane(++iCurrIdx, "right");
                    }).periodical(iPaneInterval);
                }
            });
        }

        if (oShoppage || oCategorypage || oCollectionpage || oSearchpage || oCmsSlideshow) {
            var aUL = document.getElements("section > ul[class]");
            
            aUL.each(function(obj, idx) {
                fnPopulateFooterNav(idx, true);
            });

            var sHash = document.location.hash,
                aNav = oFooter.getElements("nav ul li a"),
                regFindInt = /\d+$/g,
                iCurrIdx = (sHash && !isNaN(sHash.match(regFindInt)[0]))?sHash.match(regFindInt)[0]:1,
                aValidKeystrokes = ["left", "right"],
                oNavigateHelp = new Element("aside#navigate-help", {
                        "html": Locale.get("String.userinput.howtonavigate")
                }).inject(document.body),
                aScrollAreas = $$("a[rel=scroll]"),
                fxSlide = null,
                fnNoTransSlide = function(idx, sDir) {
                    var iDur = 1600,
                        oUL = document.getElement("ul[class].active"),
                        oCoords = (sDir == "left")?{"active":200,"next":0,"start":-200}:{"active":-200,"next":0,"start":200},
                        oNextUL = aUL[idx-1];

                    if (fxSlide == null) {
                        fxSlide = new Fx.Tween(oUL, {
                            duration: iDur,
                            transition: sTransition,
                            link: "ignore",
                            unit: "%",
                            onStart: function() {
                                new Fx.Tween(oNextUL, {
                                    duration: iDur,
                                    transition: sTransition,
                                    unit: "%",
                                    onComplete: function() {
                                        oNextUL.addClass("active");
                                    }
                                }).start("left", oCoords.start, oCoords.next);
                            },
                            onComplete: function() {
                                fxSlide = null;
                                this.removeClass("active");
                            }.bind(oUL)
                        }).start("left", 0, oCoords.active);
                    }
                },
                fnPane = function(idx, sDir) {
                    if (idx < 1) {
                        idx = aUL.length;
                    } else if (idx > aUL.length) {
                        idx = 1;
                    }

                    fadeDescription(idx, function() {
                        iCurrIdx = idx.limit(1, aUL.length);
                        if (bCSSTransitions) {
                            document.location.href = "#page" + iCurrIdx;
                            if (Browser.Platform.ios) {
                                window.scrollTo(0,0);
                            }
                        } else {
                            fnNoTransSlide(idx, sDir.trim());
                        }
                        aNav.removeClass("active");
                        aNav[iCurrIdx-1].addClass("active");
                    });
                };

            aNav.addEvent("click", function(e) {
                e.preventDefault();
                if (this.hasClass("active")) {
                    return false;
                }

                var idx = aNav.indexOf(this);
                iCurrIdx = idx + 1;
                aNav.removeClass("active");
                this.addClass("active");

                jQuery('h2.shop-title, h2.search-title, h3.category-title').animate({opacity: 0},300);
                setTimeout(function() {jQuery('h2.shop-title, h2.search-title, h3.category-title').animate({opacity: 1},300)},1500);

                fadeDescription(iCurrIdx, function() {
                    if (bCSSTransitions) {
                        document.location.href = "#page" + iCurrIdx;
                        if (Browser.Platform.ios) {
                            window.scrollTo(0,0);
                        }
                    } else {
                        fnNoTransSlide(iCurrIdx, "right");
                    }
                });
            });

            // fade in/out shop navigate help layer
            jQuery("aside#navigate-help").delay(500).fadeIn(1500).delay(2500).fadeOut(1500);

            $$("ul.articles figure").addEvent("mouseleave", function(e) {
                this.getElements("a.hotspot").removeClass("active");
            });

            $$("ul.articles figure a.hotspot").addEvents({
                "mouseenter": function(e) {
                    e.preventDefault();
                    if (Browser.Platform.ios) {
                        document.location.href = this.href;
                    } else {
                        if (document.id("tooltip")) {
                            document.id("tooltip").dispose();
                        }

                        var oA = e.target,
                            oTooltip = new Element("div#tooltip", {
                                "html": this.innerHTML,
                                "styles": {
                                    "top": oA.getPosition(oA.getOffsetParent()).y + oA.getSize().y,
                                    "left": oA.getPosition(oA.getOffsetParent()).x + oA.getStyle("padding-left").toInt()
                                }
                            }).inject(e.target, "after");

                        fnFadeinObjs([oTooltip], 250);
                    }
                },
                "mouseleave": function(e) {
                    fnDisposeObj("tooltip");
                }
            });

            if (!bCSSTransitions) {
                aUL[0].addClass("active");
            }

            if (Browser.ie && Browser.version <= 9) {
                $$("article.slides section.product:nth-of-type(4) ~ section.product .product_details").addClass("bottom");
                jQuery.fx.off = true;
            }


            if (aScrollAreas) {
                aScrollAreas.addEvent("click", function(e) {
                    e.preventDefault();
                    if (this.get("class").trim() == "left") {
                    	jQuery('h2.shop-title, h2.search-title, h3.category-title').animate({opacity: 0},1000);
                        setTimeout(function() {jQuery('h2.shop-title, h2.search-title, h3.category-title').animate({opacity: 1},1000)},1000);
                        fnPane(--iCurrIdx, this.get("class"));
                    } else {
                    	jQuery('h2.shop-title, h2.search-title, h3.category-title').animate({opacity: 0},1000);
                        setTimeout(function() {jQuery('h2.shop-title, h2.search-title, h3.category-title').animate({opacity: 1},1000)},1000);
                        fnPane(++iCurrIdx, this.get("class"));
                    }
                });
                aScrollAreas.addClass("highlight");
                (function() {
                    aScrollAreas.removeClass("highlight");
                }).delay(1000);
            }

            document.addEvent("keydown", function(e) {
                if (aValidKeystrokes.contains(e.key)) {
                    e.preventDefault();
                    if (e.key == "left") {
                        fnPane(--iCurrIdx, e.key);
                    } else {
                        fnPane(++iCurrIdx, e.key);
                    }
                }
            });

            jQuery('div.description').eq(iCurrIdx-1).fadeIn(300);
        }

        if (oItempage) {
        	jQuery('section.display').productImageNavigation();
            fnSetupColourSize();

            var aNav = oFooter.getElements("nav ul li a"),
                oForm = oItempage.getElement("section.panel form"),
                oColourSelect = oItempage.getElement("#select-colour"),
                aClose = oItempage.getElement("a.history-back-button"),
                aValidKeystrokes = ["left", "right"],
                oNavigateHelp = new Element("aside#navigate-help", {
                    "html": Locale.get("String.userinput.howtonavigate")
                	}).inject(document.body),
                fnToggleZoom = function(bShow) {
                    var oZoom = document.id("item-zoom");
                    if (oZoom) {
                        new Fx.Tween(oZoom, {
                            duration: 300,
                            onComplete: function() {
                                if (!bShow) {
                                    this.dispose();
                                }
                            }.bind(oZoom)
                        }).start("opacity", bShow?1:0)
                    }
                },
                paneZoom = function(e) {
                    if (e.type == "mouseout") {
                        return null;
                    }

                    var oA = e.target,
                        oZoom = document.id("item-zoom"),
                        oImg = oZoom.getElement("img.zoomed"),
                        iImgH = oImg.getSize().y.toInt(),
                        iMarginTop = oImg.getStyle("margin-top").toInt(),

                        iZoomH = oZoom.getSize().y.toInt(),
                        iDistance = bLegacyBrowser ? 20: 20;

                    if (oA.hasClass("bottom")) {
                        if (iImgH + iMarginTop > iZoomH + iDistance) {
                            oImg.setStyle("margin-top", iMarginTop - iDistance);
                        }
                    } else {
                        if (iMarginTop < 0) {
                            oImg.setStyle("margin-top", iMarginTop + iDistance);
                        }
                    }
                },
                aImg = $$("section.display img"),
                fxFadeImg = null,
                paneTimer = null;

            // If close button isn't in an overlay, make it a back button
            bOverlay = ($$("div#overlay").length > 0);
            if (!bOverlay && aClose) {
                aClose.addEvent("click", function(e) {
                    e.preventDefault();
                    history.back(-1);
                });
            }

            oForm.addEvent("submit", function(e) {
                e.stop();
                var bChosen = this.getElements("div.styleme > span").every(function(obj) {
                    return obj.get("data-value");
                });

                if (bChosen) {
                    this.submit();
                }
            });

            jQuery('form fieldset#product-options-wrapper ul li').click(function(event) {
            	if (typeof(prodColors[jQuery(this).text()]) != 'undefined' && typeof(prodColors[jQuery(this).text()]['full']) != 'undefined') {
            		jQuery('section.display').productImageNavigation('showItem',{index: jQuery('section.display a[href="' + prodColors[jQuery(this).text()]['full'] + '"]').parents('div.product-image').index()});
            	}
            });

        	jQuery('body.catalog-product-view div.content div.misc a:first-child').click(function (event) {
        		event.preventDefault();
        		event.stopPropagation();

       			var shippingPaymentInformation = jQuery('div#shipping-payment-information');

    			jQuery('<a href="#" onclick="jQuery(\'#shipping-payment-information\').css({visibility: \'hidden\'}); jQuery(\'body\').removeClass(\'unload\'); return false" id="close-button">x</a>').
    			appendTo(shippingPaymentInformation);

    			jQuery(shippingPaymentInformation)
    			.css({
    			//	left: ((jQuery(window).width()/2) - (jQuery(shippingPaymentInformation).outerWidth()/2)) + 'px',
    			//	top: (jQuery(window).scrollTop() + 140) + 'px',
    				visibility: 'visible',
    				display: 'block'
    			});

    			jQuery('body').addClass('unload');

    			return false;
        	});

            document.addEvent("click", function(e) {
                fnToggleZoom(false);
            });

            $$("section.display div.product-image a").addEvent("click", function(e) {
                e.preventDefault();
                e.stopPropagation();

                if (document.id("item-zoom")) {
                    fnToggleZoom(false);
                }

                if (jQuery(this).parents('div.product-image').hasClass('product-image-portrait')) {
                	zoomElementClass = "item-zoom-portrait";
                }
                else {
                	zoomElementClass = "item-zoom-landscape";
                }

                var oZoom = new Element("div", {
                    "id": "item-zoom",
                    "class": zoomElementClass
                }).adopt(
                    new Element("div#padout"),
                    // TODO: Make sure the logo appears correctly on fade up
                    // new Element("div#Logo").adopt(
                    //    new Element("img#logo", {
                    //        "src": "/skin/frontend/enterprise/acnewhite/img/logo_acne-large.png"
                    //    }),
                    // ),
                    new Element("a.up"),
                    new Element("a.bottom"),
                    new Element("div.content").adopt(
                        new Element("img.zoomed", {
                            "src": this.href,
                            "events": {
                                "click": function(e) {
                                    e.preventDefault();
                                    fnToggleZoom(false);
                                }
                            }
                        })
                    )
                ).inject(oItempage, "bottom");

                oZoom.getElements("a[class]").addEvents({
                    "mouseover": function(e) {
                        paneTimer = paneZoom.periodical(15, e.target, e);
                    },
                    "mouseout": function() {
                        clearInterval(paneTimer);
                    }
                });
                fnToggleZoom(true);
            });

			jQuery("#thumbnails").carouFredSel({
				width: 'variable',
				items : {
					visible	: 4,
					start: -1,
					minimum: 2
				},
				scroll : {
					items : 1,
					duration : 500
				},
				auto : false,
				prev : {
					button: "#tb_prev"
				},
				next : {
					button: "#tb_next"
					}
			});

			jQuery('#thumbnails li').click(function() {
			    jQuery('section.display').productImageNavigation('showItem', {index: jQuery(this).attr('data-image')});
                jQuery('#thumbnails_container').removeClass('active');
                jQuery('#thumbnails_container').animate({'bottom': -126}, 300);
                jQuery('.tb_controls').animate({'bottom': -100}, 300);
                jQuery('#thumbnails_button').animate({'top': '94%'}, 300);
			});

			jQuery('a.right').click(function() {
				jQuery('section.display').productImageNavigation('showNext');
			});

			jQuery('a.left').click(function() {
				jQuery('section.display').productImageNavigation('showPrevious');
			});

			jQuery('#tb_close').click(function(){
				jQuery('#thumbnails_container').removeClass('active');
                jQuery('#thumbnails_container').animate({'bottom': -126}, 300);
                jQuery('.tb_controls').animate({'bottom': -100}, 300);
                jQuery('#thumbnails_button').animate({'top': '94%'}, 300);
			});

            // fade in/out shop navigate help layer
            jQuery("aside#navigate-help").delay(500).fadeIn(1500).delay(2500).fadeOut(1500);

            // Item page options functionality
            // ===============================

            // Clear static size options - these will be populated
            // dynamically based on colour selection
            if (jQuery('#option-colour').length > 0) {
				jQuery('#option-size option').each(function () {
					if (jQuery(this).val() != 'Select size') {
						jQuery(this).remove();
					}
				});
				jQuery('#option-size').removeClass('jqTransformHidden').removeAttr('multiple');
				jQuery('#option-size').append('<option>Select color above</option>');
				jQuery('#option-size').parent('div').replaceWith(jQuery('#option-size'));
				jQuery('form.jqtransform select').jqTransSelect();

				// Create the click event handler for options
				jQuery('#option-colour').siblings('ul').find('a').click(function(event) {
					event.preventDefault();

					jQuery(this).parents('div.jqTransformSelectWrapper').find('a.selected').removeClass('selected');
					jQuery(this).addClass('selected');

					// Clear any previously populated options
					jQuery('#option-size').empty();

					// Get colour code of selected option
					selectedIndex = jQuery(this).attr('index');
					selectedLabel = jQuery(this).text();
					selectedColourCode = jQuery(this).parents('div.jqTransformSelectWrapper').children('select').children('option')[selectedIndex].value;

					// Change product colour image accordingly
					jQuery('div.product-image').each(function() {
						if (typeof(prodColors[selectedLabel]) != 'undefined') {
							if (jQuery(this).children('a').attr('href') == prodColors[selectedLabel]['full']) {
								jQuery('section.display').productImageNavigation('showItem',{'index': jQuery(this).index()});
							}
						}
					});
					
					if (jQuery('#option-size').length > 0) {
						// Determine the products that are available for
						// the selected colour
						for (var key = 0, length = spConfig.attributes[509].options.length; key < length; key++) {
							option = spConfig.attributes[509].options[key];
							if (option.id == selectedColourCode) {
								products = option.products;
							}
						}
	
						// Reconstruct the base select element with the revised
						// size options
						listItemIndex = 1;
						var newSelectElement = jQuery('<select id="option-size" name="super_attribute[508]"></select>');
						newSelectElement.append('<option>Select size</option>');
	
						// Determine the size options of the products available
						for (var optionsKey = 0, optionsLength = spConfig.attributes[508].options.length; optionsKey < optionsLength; optionsKey++) {
							option = spConfig.attributes[508].options[optionsKey];
							sizeLabel = option.label;
							sizeCode = option.id;
	
							for (var productsKey = 0, productsLength = option.products.length; productsKey < productsLength; productsKey++) {
								product = option.products[productsKey];
								if (jQuery.inArray(product, products) != -1) {
									newSelectElement.append('<option value="' + sizeCode + '">' + sizeLabel + '</option>');
									listItemIndex++;
								}
							}
						}
	
						// Replace the old select element and invoke the form
						// decoration plugin to style the new elements
						jQuery('#option-size').parent('div').replaceWith(newSelectElement);
						jQuery('form.jqtransform select').jqTransSelect();
	
						jQuery('#option-size').siblings('ul').find('a').click(function() {
       					    jQuery(this).parents('div.jqTransformSelectWrapper').find('a.selected').removeClass('selected');
    					    jQuery(this).addClass('selected');
						
							var selectedSizeCode = jQuery('#option-size option')[jQuery(this).attr('index')].value;
							jQuery.get('/checkout/cart/available/?product=' + spConfig['productId'] + '&super_attribute[508]=' + selectedSizeCode + '&super_attribute[509]=' + selectedColourCode,function(data) {
								jQuery('#option-size').siblings('div').children('span').append(' ' + data);
								if (data == '') {
									jQuery('#option-size').siblings('div').children('span').append(Locale.get("String.forms.notinstock"));
								}
							});
						});
					} else {
						var selectedColourCode = jQuery('#option-colour option')[jQuery(this).attr('index')].value;
						jQuery.get('/checkout/cart/available/?product=' + spConfig['productId'] + '&super_attribute[509]=' + selectedColourCode,function(data) {
							jQuery('#option-colour').siblings('div').children('span').append(' ' + data);
							if (data == '') {
								jQuery('#option-size').siblings('div').children('span').append(Locale.get("String.forms.notinstock"));
							}
						});					    
					}
				});
			}
			else if (jQuery('#option-size').length > 0) {		
				jQuery('#option-size').siblings('ul').find('a').click(function() {
				    jQuery(this).parents('div.jqTransformSelectWrapper').find('a.selected').removeClass('selected');
				    jQuery(this).addClass('selected');
					var selectedSizeCode = jQuery('#option-size option')[jQuery(this).attr('index')].value;
					jQuery.get('/checkout/cart/available/?product=' + spConfig['productId'] + '&super_attribute[508]=' + selectedSizeCode,function(data) {
						jQuery('#option-size').siblings('div').children('span').append(' ' + data);
						if (data == '') {
							jQuery('#option-size').siblings('div').children('span').append(Locale.get("String.forms.notinstock"));
						}
					});
				});
			}

			jQuery('#thumbnails_button').click(function() {
			    if (jQuery('#thumbnails_container').hasClass('active')) {
			        jQuery('#thumbnails_container').removeClass('active');
			        jQuery('#thumbnails_container').animate({'bottom': -100}, 300);
			        jQuery('.tb_controls').animate({'bottom': -100}, 300);
			        jQuery(this).animate({'top': '94%'}, 300);
			    } else {
			        jQuery('#thumbnails_container').addClass('active');
    			    jQuery('#thumbnails_container').animate({'bottom': 0}, 300);
    			    jQuery('.tb_controls').animate({'bottom': 0}, 300);
    			    jQuery(this).animate({'top': '110%'}, 300);
    			}
			});
        }

        if (oCareerpage) {
            new Element("div#logo").inject(oCareerpage, "bottom");
        }
    },
    "load": function() {
        document.getElement("body").addClass("complete");
        fnResizeScrollArea();
    },
    "resize": function() {
        fnResizeScrollArea();
    }
});


jQuery(document).ready(function(){
	//Product description slide up for the category page
	jQuery("section.product_details").hide();
	
	jQuery("section.product").mouseenter(function(){
		jQuery("section.product_details",this).fadeTo(100, 1);
	});

	jQuery("section.product").mouseleave(function(){
		jQuery("section.product_details",this).fadeTo(100, 0);
	});

	//Change classes for dropdown headings on item page
	jQuery(".share h2").click(function(){
		jQuery(".share h2").toggleClass('open');
	});
	jQuery("#related h2").click(function(){
		jQuery("#related h2").toggleClass('open');
	});

	//add class to parent section of portrait images
	jQuery(".product-image-portrait").parent().addClass('portrait');

	//POP UP BOXES 
	//hide popup boxes initially
	jQuery(".popup-box").hide();
	
	//Adjust height of overlay to fill screen when page loads
	jQuery("#popup-overlay").css("height", jQuery(document).height());
	
	//When the link that triggers the message is clicked fade in overlay and next popup box
	jQuery(".popup").click(function(){
		//fadein causes black flash in IE8 so show instea
		if (jQuery.browser.msie && jQuery.browser.version <= 8 ) {		
			jQuery("#popup-overlay").show();		
		} else {
			jQuery("#popup-overlay").fadeIn();
		}
		jQuery(this).next(".popup-box").fadeIn();
		return false;
});
	
	//Close button
	jQuery(".close").click(function(){
		jQuery("#popup-overlay").fadeOut();
		jQuery(".popup-box").fadeOut();
		return false;
	});
	
	//Close when click on overlay
	jQuery("#popup-overlay").click(function(){
		//fadeout causes black flash in IE8 so show instead
		if (jQuery.browser.msie && jQuery.browser.version <= 8 ) {		
			jQuery("#popup-overlay").hide();		
		} else {
			jQuery("#popup-overlay").fadeOut();
		}
		jQuery(".popup-box").fadeOut();
		jQuery('form#newsletter-validate-detail').hide();
		return false;
	});
	
	//shop grid overlays*/
	jQuery('.box').hover(function(){

		jQuery(this).css('opacity','0.4');
		jQuery(this).next('ul').children('li').css('opacity','1');
		
		jQuery(this).siblings('.box').css('opacity','1');
		jQuery(this).siblings('.box').next('ul').children('li').css('opacity','0');
	});
	
	jQuery('#shop-grid').mouseleave(function(){
		jQuery('.box').css('opacity','1');
		jQuery('#shop-grid li').css('opacity','0');
	});
	
	jQuery('#shop-grid h2').css('left','0');

	
	//Scaling fix for ie8 as media queries don't work
	if( (jQuery(window).width() < 800) || (jQuery(window).height() < 600)){
		jQuery('body').addClass('ie-scaling');
	};
});

//Adjust height of overlay to fill screen when browser gets resized
jQuery(window).bind("resize", function(){
	jQuery("#popup-overlay").css("height", jQuery(window).height());
});
